<% if error.present? %>
  <p style="color:#b45309; font-weight:bold;">
    ⚠️ ИИ не смог определить вас в категорию
  </p>
  <p>Попробуйте изменить формулировку текста и отправить его ещё раз.</p>

<% elsif results.present? && results.any? %>

  <p><strong>Ваш текст:</strong></p>
  <blockquote><%= text %></blockquote>

  <h3>Результат классификации</h3>
  <ul>
    <% results.each do |r| %>
      <li>
        <strong><%= PredictionsController::LABEL_TRANSLATIONS[r["label"]] || r["label"] %></strong>
        — <%= (r["score"] * 100).round(1) %>%
      </li>
    <% end %>
  </ul>

  <% if prediction.present? %>
    <hr>

    <p><strong>Правильно ли мы вас поняли?</strong></p>

    <!-- YES button -->
    <button id="yes-button">Да</button>

    <p style="margin-top:1rem;">
      Если нет — выберите правильную категорию:
    </p>

    <%= form_with url: feedback_prediction_path(prediction),
                  method: :post do %>
      <%= hidden_field_tag :correct, false %>

      <%= select_tag :correct_label,
        options_for_select(
          [["— Выберите категорию —", ""]] +
          PredictionsController::LABEL_TRANSLATIONS.map { |k, v| [v, k] }
        ),
        required: true %>

      <br><br>
      <%= submit_tag "Отправить исправление" %>
    <% end %>

    <!-- Minimal JS to change button visually -->
    <script>
      document.addEventListener("turbo:load", () => {
        const yesButton = document.getElementById("yes-button");
        if (!yesButton) return;

        yesButton.addEventListener("click", function(e) {
          yesButton.textContent = "✅ Подтверждено";
          yesButton.disabled = true;

          fetch("<%= feedback_prediction_path(prediction) %>", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ correct: true })
          });
        });
      });
    </script>

  <% end %>

<% end %>
