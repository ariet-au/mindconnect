<div id="prediction_container" class="space-y-6">
  <% if error.present? %>
    <div class="p-4 bg-amber-50 border-l-4 border-amber-500 rounded">
      <p class="text-amber-700 font-bold">⚠️ ИИ не смог определить категорию</p>
      <p class="text-amber-600 text-sm">Попробуйте изменить формулировку текста и отправить его ещё раз.</p>
    </div>

  <% elsif results.present? %>
    <section class="user-query italic text-gray-600 border-l-2 pl-4 py-2">
      "<%= text %>"
    </section>

    <section class="results-box bg-white p-4 shadow-sm border rounded-lg">
      <h3 class="text-lg font-semibold mb-3">Результат классификации</h3>
      <div class="space-y-2">
        <% results.each do |r| %>
          <div class="flex items-center justify-between">
            <span class="font-medium text-gray-800">
              <%= PredictionsController::LABEL_TRANSLATIONS[r["label"]] || r["label"] %>
            </span>
            <span class="text-sm text-blue-600 bg-blue-50 px-2 py-1 rounded">
              <%= t("ml_confidence.#{r['confidence']}") %>
            </span>
          </div>
          <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
            <div class="bg-blue-500 h-full" style="width: <%= r["score"] * 100 %>%"></div>
          </div>
        <% end %>
      </div>
    </section>

    <% if prediction.present? %>
      <hr class="my-6">

      <div id="feedback_section" class="text-center">
        <p class="font-semibold mb-4 text-gray-700">Правильно ли мы вас поняли?</p>
        
        <div class="flex flex-col sm:flex-row gap-3 justify-center items-center">
          <%= form_with url: feedback_prediction_path(prediction), method: :post, id: "yes-form", class: "w-full sm:w-auto" do %>
            <%= hidden_field_tag :correct, true %>
            <button type="submit" id="yes-button" class="w-full px-8 py-2 bg-green-600 text-white rounded-full hover:bg-green-700 transition-all font-medium">
              Да, всё верно
            </button>
          <% end %>

          <button id="show-correction" class="px-8 py-2 border border-gray-300 rounded-full hover:bg-gray-50 transition-all text-gray-600">
            Нет, выбрать другую
          </button>
        </div>

        <div id="correction-form" class="hidden mt-6 p-4 bg-gray-50 rounded-lg border border-dashed text-left">
          <p class="text-sm text-gray-600 mb-3 font-medium">Выберите правильную категорию:</p>
          <%= form_with url: feedback_prediction_path(prediction), method: :post do %>
            <%= hidden_field_tag :correct, false %>
            <%= select_tag :correct_label,
                options_for_select(
                  [["— Выберите категорию —", ""]] +
                  PredictionsController::LABEL_TRANSLATIONS.map { |k, v| [v, k] }
                ),
                required: true,
                class: "w-full p-2 border rounded-md mb-3" %>
            <button type="submit" class="w-full py-2 bg-gray-800 text-white rounded hover:bg-black transition-colors">
              Отправить исправление
            </button>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# This is where the Turbo Stream from the 'feedback' action will land %>
    <div id="psychologist_results" class="mt-8"></div>

    <script>
      (function() {
        const setupUI = () => {
          // 1. Toggle Correction Form
          const showBtn = document.getElementById("show-correction");
          const form = document.getElementById("correction-form");
          if (showBtn && form) {
            showBtn.onclick = () => {
              form.classList.toggle("hidden");
              showBtn.classList.toggle("bg-gray-200");
            };
          }

          // 2. Yes Button Feedback
          const yesForm = document.getElementById("yes-form");
          if (yesForm) {
            yesForm.onsubmit = () => {
              const btn = document.getElementById("yes-button");
              btn.textContent = "✅ Подтверждено";
              btn.classList.replace("bg-green-600", "bg-green-700");
              btn.disabled = true;
              document.getElementById("show-correction")?.remove();
            };
          }
        };

        // Initialize on load and every time Turbo updates the frame
        document.addEventListener("turbo:load", setupUI);
        document.addEventListener("turbo:frame-render", setupUI);
        setupUI(); // Run once immediately in case of partial render

        // 3. Scroll to Psychologists when Turbo Stream arrives
        document.addEventListener("turbo:before-stream-render", (event) => {
          const fallbackRender = event.detail.render;
          
          event.detail.render = (streamElement) => {
            fallbackRender(streamElement); // Execute the update

            // Check if the update was for our psychologist div
            if (streamElement.getAttribute("target") === "psychologist_results") {
              const target = document.getElementById("psychologist_results");
              if (target) {
                setTimeout(() => {
                  target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
              }
            }
          };
        });
      })();
    </script>
  <% end %>
</div>