<div class="container mx-auto mt-10">
  <h1 class="text-2xl font-bold mb-4">Scroll Depth by Page</h1>

  <!-- Psychologist Profiles Chart -->
  <h2 class="text-xl font-semibold mt-6">Psychologist Profiles</h2>
  <canvas id="psychChart"></canvas>

  <!-- Other Pages Chart -->
  <h2 class="text-xl font-semibold mt-6">Other Pages (Normalized)</h2>
  <canvas id="otherChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("turbo:load", () => {
  fetch("<%= scroll_stats_analytics_path(format: :json) %>")
    .then(r => r.json())
    .then(data => {

      const renderHorizontalChart = (ctxId, stats, color, labelField = "label") => {
        // Sort descending by average scroll
        const sortedStats = stats.sort((a, b) => b.avg_scroll - a.avg_scroll);

        const ctx = document.getElementById(ctxId);

        // Dynamic canvas height: 25px per bar
        ctx.height = sortedStats.length * 25;

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: sortedStats.map(d => d[labelField]),
            datasets: [{
              label: 'Average Scroll %',
              data: sortedStats.map(d => d.avg_scroll),
              backgroundColor: color,
              borderWidth: 1,
              maxBarThickness: 20  // caps bar thickness
            }]
          },
          options: {
            indexAxis: 'y',  // horizontal bars
            responsive: true,
            scales: {
              x: { beginAtZero: true, max: 100 },
              y: { ticks: { autoSkip: false } } // show all labels
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: ctx => `${ctx.parsed.x}% average scroll`
                }
              }
            }
          }
        });
      };

      // Render Psychologist Profiles (ID + Name)
      renderHorizontalChart("psychChart", data.psych_stats, "rgba(54, 162, 235, 0.5)");

      // Render Other Pages (normalized URLs)
      renderHorizontalChart("otherChart", data.other_stats, "rgba(255, 159, 64, 0.5)", "url");
    });
});
</script>
