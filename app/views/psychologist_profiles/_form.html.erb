<%= form_with(model: psychologist_profile, local: true, html: { multipart: true, class: 'box' }) do |form| %>
  <% if psychologist_profile.errors.any? %>
    <div class="notification is-danger">
      <h2 class="subtitle"><%= pluralize(psychologist_profile.errors.count, "error") %> prohibited this psychologist_profile from being saved:</h2>

      <ul>
        <% psychologist_profile.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="columns is-multiline">
    <!-- First Name -->
    <div class="column is-half">
      <div class="field">
        <%= form.label :first_name, class: "label" %>
        <div class="control">
          <%= form.text_field :first_name, class: "input" %>
        </div>
      </div>
    </div>

    <!-- Last Name -->
    <div class="column is-half">
      <div class="field">
        <%= form.label :last_name, class: "label" %>
        <div class="control">
          <%= form.text_field :last_name, class: "input" %>
        </div>
      </div>
    </div>

    <!-- About Me -->
    <div class="column is-full">
      <div class="field">
        <%= form.label :about_me, class: "label" %>
        <div class="control">
          <%= form.text_area :about_me, class: "textarea" %>
        </div>
      </div>
    </div>

    <!-- Specialties -->
    <div class="column is-one-third">
      <div class="field">
        <%= form.label :specialty_ids, "Select Specialties", class: "label" %>
        <div class="control">
          <div class="select is-multiple">
            <%= form.collection_select :specialty_ids, Specialty.all, :id, :name, {}, { multiple: true, size: 5, class: "input" } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Client Types -->
    <div class="column is-one-third">
      <div class="field">
        <%= form.label :client_type_ids, "Select Client Types", class: "label" %>
        <div class="control">
          <div class="select is-multiple">
            <%= form.collection_select :client_type_ids, ClientType.all, :id, :name, {}, { multiple: true, size: 5, class: "input" } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Issues -->
    <div class="column is-one-third">
      <div class="field">
        <%= form.label :issue_ids, "Select Issues", class: "label" %>
        <div class="control">
          <div class="select is-multiple">
            <%= form.collection_select :issue_ids, Issue.all, :id, :name, {}, { multiple: true, size: 5, class: "input" } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Upload -->
    <div class="column is-full">
      <div class="field">
        <label class="button is-link is-light">
          Upload Profile Image
          <input type="file" id="imageInput" accept="image/*" hidden>
        </label>
        <input type="file" id="croppedImageInput" name="psychologist_profile[profile_img]" hidden>
      </div>
    </div>

    <!-- Years of Experience -->
    <div class="column is-half">
      <div class="field">
        <%= form.label :years_of_experience, class: "label" %>
        <div class="control">
          <%= form.number_field :years_of_experience, class: "input" %>
        </div>
      </div>
    </div>

    <!-- License Number -->
    <div class="column is-half">
      <div class="field">
        <%= form.label :license_number, class: "label" %>
        <div class="control">
          <%= form.text_field :license_number, class: "input" %>
        </div>
      </div>
    </div>

    <!-- Country -->
    <div class="column is-half">
      <div class="field">
        <%= form.label :country, class: "label" %>
        <div class="control">
          <div class="select">
            <%= form.select :country, 
                options_for_select(country_list, selected: @psychologist_profile.country),
                { include_blank: 'Select Country' },
                class: 'input' %>
          </div>
        </div>
      </div>
    </div>

    <!-- City -->
    <div class="column is-half">
      <div class="field">
        <%= form.label :city, class: "label" %>
        <div class="control">
          <%= form.text_field :city, class: "input" %>
        </div>
      </div>
    </div>

    <!-- Address -->
    <div class="column is-full">
      <div class="field">
        <%= form.label :address, class: "label" %>
        <div class="control">
          <%= form.text_field :address, class: "input" %>
        </div>
      </div>
    </div>

    <!-- Contact Information -->
    <div class="column is-one-third">
      <div class="field">
        <%= form.label :telegram, class: "label" %>
        <div class="control">
          <%= form.text_field :telegram, class: "input" %>
        </div>
      </div>
    </div>

    <div class="column is-one-third">
      <div class="field">
        <%= form.label :whatsapp, class: "label" %>
        <div class="control">
          <%= form.text_field :whatsapp, class: "input" %>
        </div>
      </div>
    </div>

    <div class="column is-one-third">
      <div class="field">
        <%= form.label :contact_phone, class: "label" %>
        <div class="control">
          <%= form.text_field :contact_phone, class: "input" %>
        </div>
      </div>
    </div>

    <!-- Additional Phones -->
    <div class="column is-half">
      <div class="field">
        <%= form.label :contact_phone2, class: "label" %>
        <div class="control">
          <%= form.text_field :contact_phone2, class: "input" %>
        </div>
      </div>
    </div>

    <div class="column is-half">
      <div class="field">
        <%= form.label :contact_phone3, class: "label" %>
        <div class="control">
          <%= form.text_field :contact_phone3, class: "input" %>
        </div>
      </div>
    </div>

    <!-- Gender -->
    <div class="column is-half">
      <div class="field">
        <%= form.label :gender, class: "label" %>
        <div class="control">
          <div class="select">
            <%= form.select :gender, 
                PsychologistProfile.genders.map { |key, value| [key.humanize, key] },
                { selected: 'unspecified' },
                class: "input" %>
          </div>
        </div>
      </div>
    </div>

    <!-- Education -->
    <div class="column is-half">
      <div class="field">
        <%= form.label :education, class: "label" %>
        <div class="control">
          <%= form.text_field :education, class: "input" %>
        </div>
      </div>
    </div>

    <!-- Checkboxes -->
    <div class="column is-half">
      <div class="field">
        <label class="checkbox">
          <%= form.check_box :is_doctor, class: "checkbox" %>
          <%= form.label :is_doctor, "Is a Doctor?", class: "checkbox" %>
        </label>
      </div>
    </div>

    <div class="column is-half">
      <div class="field">
        <label class="checkbox">
          <%= form.check_box :is_degree_boolean, class: "checkbox" %>
          <%= form.label :is_degree_boolean, "Has Degree?", class: "checkbox" %>
        </label>
      </div>
    </div>

    <!-- Submit Button -->
    <div class="column is-full">
      <div class="field">
        <div class="control">
          <%= form.submit class: "button is-primary is-fullwidth" %>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for cropping -->
  <div class="modal" id="cropModal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title">Crop Your Image</p>
        <button class="delete" id="closeModal" aria-label="close"></button>
      </header>
      <section class="modal-card-body">
        <img id="imagePreview" style="max-width: 100%;">
      </section>
      <footer class="modal-card-foot">
        <button type="button" class="button is-primary" id="confirmCrop">Confirm</button>
        <button type="button" class="button" id="cancelCrop">Cancel</button>
      </footer>
    </div>
  </div>
<% end %>

<script>
let cropper;
const imageInput = document.getElementById("imageInput");
const imagePreview = document.getElementById("imagePreview");
const cropModal = document.getElementById("cropModal");
const confirmCrop = document.getElementById("confirmCrop");
const cancelCrop = document.getElementById("cancelCrop");
const closeModal = document.getElementById("closeModal");
const croppedImageInput = document.getElementById("croppedImageInput");

// Open modal on file selection
imageInput.addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    imagePreview.src = e.target.result;
    cropModal.classList.add("is-active");

    imagePreview.onload = function () {
      if (cropper) cropper.destroy();
      cropper = new Cropper(imagePreview, {
        aspectRatio: 1,
        viewMode: 1,
      });
    };
  };
  reader.readAsDataURL(file);
});

// Close modal
[cancelCrop, closeModal].forEach((btn) => {
  btn.addEventListener("click", () => {
    cropModal.classList.remove("is-active");
    if (cropper) cropper.destroy();
  });
});

// On confirm crop: generate blob, create a File, and assign to hidden input
confirmCrop.addEventListener("click", () => {
  cropper.getCroppedCanvas().toBlob((blob) => {
    const file = new File([blob], "cropped_profile.jpg", { type: "image/jpeg" });

    // Simulate user selecting this file in hidden input
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    croppedImageInput.files = dataTransfer.files;

    // Close modal
    cropModal.classList.remove("is-active");
    cropper.destroy();
  });
});
</script>