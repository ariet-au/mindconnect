<%= form_with(model: psychologist_profile, local: true, html: { multipart: true }) do |form| %>
  <% if psychologist_profile.errors.any? %>
    <div class="notification is-danger mb-6">
      <h2 class="subtitle"><%= t('psychologist_profile.errors.header', count: psychologist_profile.errors.count) %></h2>
      <ul>
        <% psychologist_profile.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="columns is-multiline">

    <!-- Section: Basic Information -->
    <div class="column is-full">
      <div class="box">
        <h3 class="title is-4 has-text-weight-semibold border-bottom pb-4 mb-5">
          <span class="icon-text">
            <span class="icon"><i class="fas fa-user-circle"></i></span>
            <span><%= t('psychologist_profile.sections.basic_information') %></span>
          </span>
        </h3>
        <div class="columns is-multiline">
          <div class="column is-half">
            <div class="field">
            <!-- Preview container -->
          <div id="preview-container" style="margin-top: 1rem;">
              <%= image_tag(
                    @psychologist_profile&.profile_img&.attached? ? url_for(@psychologist_profile.profile_img) : asset_path("default-profile.png"),
                    id: "imagePreview",
                    style: "max-width: 200px;"
                  ) %>
            </div>
              <%= form.label :profile_img, t('psychologist_profile.labels.upload_profile_image'), class: "label" %>
              <label class="button is-link is-light">
                <span class="icon"><i class="fas fa-upload"></i></span>
                <span><%= t('psychologist_profile.labels.choose_file') %></span>
                <input type="file" id="imageInput" accept="image/*" hidden>
              </label>
              <input type="file" id="croppedImageInput" name="psychologist_profile[profile_img]" hidden>
            </div>
          </div>
          <div class="column is-half">
            <div class="field">
              <%= form.label :timezone, t('psychologist_profile.labels.timezone'), class: "label" %>
              <div class="control is-expanded">
                 <%= form.select :timezone,
                  TZInfo::Timezone.all_identifiers.map { |id|
                    begin
                      tz = TZInfo::Timezone.get(id)
                      offset = tz.current_period.offset.utc_total_offset / 3600.0
                      formatted_offset = "GMT#{offset >= 0 ? '+' : ''}#{offset.to_i}"
                      ["(#{formatted_offset}) #{id}", id]
                    rescue TZInfo::InvalidTimezoneIdentifier
                      nil
                    end
                  }.compact,
                  { prompt: t('psychologist_profile.prompts.select_timezone') },
                  { id: "timezone_select", class: "input" }
                %>
              </div>
            </div>
          </div>
          <div class="column is-half">
            <div class="field">
              <%= form.label :first_name, t('psychologist_profile.labels.first_name'), class: "label" %>
              <div class="control">
                <%= form.text_field :first_name, class: "input" %>
              </div>
            </div>
          </div>
          <div class="column is-half">
            <div class="field">
              <%= form.label :last_name, t('psychologist_profile.labels.last_name'), class: "label" %>
              <div class="control">
                <%= form.text_field :last_name, class: "input" %>
              </div>
            </div>
          </div>
          <div class="column is-full">
            <div class="field">
              <%= form.label :about_me, t('psychologist_profile.labels.about_me'), class: "label" %>
              <div class="control">
                <%= form.text_area :about_me, class: "textarea" %>
              </div>
            </div>
          </div>
           <div class="column is-full">
            <div class="field">
              <%= form.label :youtube_video_url, t('psychologist_profile.labels.youtube_video_url'), class: "label" %>
              <div class="control">
                <%= form.text_field :youtube_video_url, class: "input", placeholder: "https://www.youtube.com/watch?v=abc123xyz" %>
              </div>
              <% if form.object.errors[:youtube_video_url].any? %>
                <p class="help is-danger"><%= form.object.errors[:youtube_video_url].first %></p>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section: Professional Details -->
    <div class="column is-full">
        <div class="box">
            <h3 class="title is-4 has-text-weight-semibold border-bottom pb-4 mb-5">
              <span class="icon-text">
                <span class="icon"><i class="fas fa-briefcase"></i></span>
                <span><%= t('psychologist_profile.sections.professional_details') %></span>
              </span>
            </h3>
            <div class="columns is-multiline">
                <div class="column is-half">
                    <div class="field">
                        <%= form.label :years_of_experience, t('psychologist_profile.labels.years_of_experience'), class: "label" %>
                        <div class="control">
                            <%= form.number_field :years_of_experience, class: "input" %>
                        </div>
                    </div>
                </div>
                <div class="column is-one-quarter">
                    <div class="field">
                        <%= form.label :standard_rate, t('psychologist_profile.labels.standard_rate'), class: "label" %>
                        <div class="control">
                            <%= form.number_field :standard_rate, step: 0.01, min: 0, class: "input", placeholder: t('psychologist_profile.placeholders.standard_rate') %>
                        </div>
                    </div>
                </div>
                <div class="column is-one-quarter">
                    <div class="field">
                        <%= form.label :currency, t('psychologist_profile.labels.currency'), class: "label" %>
                        <div class="control">
                            <div class="select is-fullwidth">
                                <%= form.select :currency, options_for_select(['KGS', 'KZT', 'UZS', 'USD', 'RUB'], selected: @psychologist_profile.currency), { include_blank: t('psychologist_profile.prompts.select_currency') } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section: Education History -->
    <div class="column is-full">
        <div class="box">
            <h3 class="title is-4 has-text-weight-semibold border-bottom pb-4 mb-5">
                <span class="icon-text">
                    <span class="icon"><i class="fas fa-graduation-cap"></i></span>
                    <span><%= t('psychologist_profile.sections.education_history') %></span>
                </span>
            </h3>
            <div id="educations-container">
                <%= form.fields_for :educations do |education_fields| %>
                    <%= render "educations/form", f: education_fields %>
                <% end %>
            </div>
            <button type="button" class="button is-info is-light mt-4" id="add-education-button">
                <span class="icon"><i class="fas fa-plus"></i></span>
                <span><%= t('psychologist_profile.buttons.add_education') %></span>
            </button>
        </div>
    </div>


    <!-- Section: Client & Issue Details -->
    <div class="column is-full">
      <div class="box">
        <h3 class="title is-4 has-text-weight-semibold border-bottom pb-4 mb-5">
          <span class="icon-text">
            <span class="icon"><i class="fas fa-clipboard-list"></i></span>
            <span><%= t('psychologist_profile.sections.client_issue_details') %></span>
          </span>
        </h3>
        <div class="columns is-multiline">
          <div class="column is-full">
            <div class="field">
              <%= form.label :issue_ids, t('psychologist_profile.labels.select_issues'), class: "label" %>
              <div class="control">
                <%= form.collection_select :issue_ids, Issue.all, :id, :name, {}, { multiple: true, class: "tom-select-issues" } %>
              </div>
            </div>
            <div class="field">
              <%= form.label :about_issues, t('psychologist_profile.labels.about_issues'), class: "label" %>
              <div class="control">
                <%= form.text_area :about_issues, class: "textarea" %>
              </div>
            </div>
          </div>
          <div class="column is-full">
            <div class="field">
              <%= form.label :client_type_ids, t('psychologist_profile.labels.select_client_types'), class: "label" %>
              <div class="control">
<%= form.collection_select :client_type_ids, ClientType.all, :id, ->(client_type) { t("client_types.#{client_type.name}") }, {}, { multiple: true, class: "tom-select-client-types" } %>
              </div>
            </div>
             <div class="field">
              <%= form.label :about_clients, t('psychologist_profile.labels.about_clients'), class: "label" %>
              <div class="control">
                <%= form.text_area :about_clients, class: "textarea" %>
              </div>
            </div>
          </div>
          <div class="column is-full">
            <div class="field">
              <%= form.label :specialty_ids, t('psychologist_profile.labels.select_specialties'), class: "label" %>
              <div class="control">
                <%= form.collection_select :specialty_ids, Specialty.all, :id, :name, {}, { multiple: true, class: "tom-select-specialties" } %>
              </div>
            </div>
            <div class="field">
              <%= form.label :about_specialties, t('psychologist_profile.labels.about_specialties'), class: "label" %>
              <div class="control">
                <%= form.text_area :about_specialties, class: "textarea" %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Section: Contact & Service Details -->
    <div class="column is-full">
      <div class="box">
        <h3 class="title is-4 has-text-weight-semibold border-bottom pb-4 mb-5">
          <span class="icon-text">
            <span class="icon"><i class="fas fa-address-book"></i></span>
            <span><%= t('psychologist_profile.sections.contact_service_details') %></span>
          </span>
        </h3>
        <div class="columns is-multiline">
          <div class="column is-half">
             <div class="field">
              <%= form.label :gender, t('psychologist_profile.labels.gender'), class: "label" %>
              <div class="control">
                <div class="select is-fullwidth">
                  <%= form.select :gender, PsychologistProfile.genders.map { |key, value| [t("psychologist_profile.gender_options.#{key}"), key] }, {}, class: "input" %>
                </div>
              </div>
            </div>
          </div>
          <div class="column is-half">
            <div class="field">
              <%= form.label :profile_url, t('psychologist_profile.labels.profile_url'), class: "label" %>
              <div class="control">
                <%= form.text_field :profile_url, class: "input", id: "profile_url_input", placeholder: "letters, numbers, - or _" %>
              </div>
              <p class="help is-info" id="profile_url_rules">
                <%= t('psychologist_profile.labels.profile_url_rules', default: "3–30 chars, lowercase letters, numbers, hyphens, underscores, слитно буквыы от 3 до 30") %>
              </p>
              <p class="help is-danger" id="profile_url_error" style="display: none;"></p>

              <!-- URL preview always visible -->
              <p class="help is-info mt-2">
                
                <strong>https://aksanaa.com/p/<span id="profile_url_preview"><%= @psychologist_profile&.profile_url.presence || 'your-url-here' %></span></strong>
              </p>
            </div>
          </div>
          <div class="column is-half">
            <div class="field">
              <%= form.label :country, t('psychologist_profile.labels.country'), class: "label" %>
              <div class="control">
                <div class="select is-fullwidth">
                  <%= form.select :country, options_for_select(countries_with_cities.map { |c| c['name'] }, selected: @psychologist_profile.country), { include_blank: t('psychologist_profile.prompts.select_country') }, { class: 'input', id: 'country-select' } %>
                </div>
              </div>
            </div>
          </div>
          <div class="column is-half">
            <div class="field">
              <%= form.label :city, t('psychologist_profile.labels.city'), class: "label" %>
              <div class="control">
                <div class="select is-fullwidth">
                  <%= form.select :city, [], { selected: @psychologist_profile.city }, { include_blank: t('psychologist_profile.prompts.select_city'), class: 'input', id: 'city-select', disabled: true } %>
                </div>
              </div>
            </div>
          </div>
          <div class="column is-full">
            <div class="field">
              <%= form.label :address, t('psychologist_profile.labels.address'), class: "label" %>
              <div class="control">
                <%= form.text_field :address, class: "input" %>
              </div>
            </div>
          </div>
          <div class="column is-one-third">
            <div class="field">
              <%= form.label :telegram, t('psychologist_profile.labels.telegram'), class: "label" %>
              <div class="control">
                <%= form.text_field :telegram, class: "input" %>
              </div>
            </div>
          </div>
          <div class="column is-one-third">
            <div class="field">
              <%= form.label :whatsapp, t('psychologist_profile.labels.whatsapp'), class: "label" %>
              <div class="control">
                <%= form.text_field :whatsapp, class: "input" %>
              </div>
            </div>
          </div>
          <div class="column ">
            <div class="field">
              <%= form.label :contact_email, t('psychologist_profile.labels.contact_email'), class: "label" %>
              <div class="control">
                <%= form.text_field :contact_email, class: "input" %>
              </div>
            </div>
          </div>
          <div class="column is-one-third">
            <div class="field">
              <%= form.label :contact_phone, t('psychologist_profile.labels.contact_phone1'), class: "label" %>
              <div class="control">
                <%= form.text_field :contact_phone, class: "input" %>
              </div>
            </div>
          </div>
          <div class="column is-one-third">
            <div class="field">
              <%= form.label :contact_phone2, t('psychologist_profile.labels.contact_phone2'), class: "label" %>
              <div class="control">
                <%= form.text_field :contact_phone2, class: "input" %>
              </div>
            </div>
          </div>
          <div class="column is-one-third">
            <div class="field">
              <%= form.label :contact_phone3, t('psychologist_profile.labels.contact_phone3'), class: "label" %>
              <div class="control">
                <%= form.text_field :contact_phone3, class: "input" %>
              </div>
            </div>
          </div>

          
          <div class="column is-full">
            <div class="field">
              <%= form.label :primary_contact_method, t('psychologist_profile.labels.primary_contact_method'), class: "label" %>
              <div class="control">
                <div class="select is-fullwidth">
                  <%= form.select :primary_contact_method, options_for_select([
                      [t('psychologist_profile.contact_methods.telegram'), 'telegram'],
                      [t('psychologist_profile.contact_methods.whatsapp'), 'whatsapp'],
                      [t('psychologist_profile.contact_methods.phone1'), 'contact_phone'],
                      [t('psychologist_profile.contact_methods.phone2'), 'contact_phone2'],
                      [t('psychologist_profile.contact_methods.phone3'), 'contact_phone3'],
                      [t('psychologist_profile.contact_methods.contact_email'), 'contact_email'],
                    ], selected: @psychologist_profile.primary_contact_method), { include_blank: t('psychologist_profile.prompts.select_primary_contact') } %>
                </div>
              </div>
            </div>
          </div>
          <div class="column is-full">
            <div class="field">
              <%= form.label :language_ids, t('psychologist_profile.labels.select_languages'), class: "label" %>
              <div class="control">
                <%= form.collection_select :language_ids, Language.all, :id, :name, {}, { multiple: true, class: "tom-select-languages" } %>
              </div>
            </div>
          </div>
          <div class="column is-full">
            <div class="field">
              <%= form.label :featured_service_id, t('psychologist_profile.labels.featured_service'), class: "label" %>
              <div class="control">
                 <div class="select is-fullwidth">
                    <%= form.collection_select :featured_service_id, @psychologist_profile.user.services, :id, :name, { prompt: t('psychologist_profile.prompts.select_featured_service') }, { class: "input" } %>
                 </div>
              </div>
            </div>
          </div>
          <div class="column is-half">
            <div class="field">
              <label class="checkbox">
                <%= form.check_box :in_person %>
                <%= t('psychologist_profile.labels.in_person_services') %>
              </label>
            </div>
          </div>
          <div class="column is-half">
            <div class="field">
              <label class="checkbox">
                <%= form.check_box :online %>
                <%= t('psychologist_profile.labels.online_services') %>
              </label>
            </div>
          </div>

          <div class="column is-full">
            <div class="field">
              <label class="checkbox">
                <%= form.check_box :hidden %>
                <%= t('psychologist_profile.labels.hidden') %>
              </label>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Submit Button -->
  <div class="field mt-6">
    <div class="control">
      <%= form.submit t('psychologist_profile.buttons.submit'), class: "button is-primary is-fullwidth is-large" %>
    </div>
  </div>

  <!-- Modal for Image Cropping -->
  <div class="modal" id="cropModal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title"><%= t('psychologist_profile.modal.crop_image_title') %></p>
        <button class="delete" id="closeModal" aria-label="<%= t('psychologist_profile.modal.close_button_aria') %>"></button>
      </header>
      <section class="modal-card-body">
        <img id="imagePreview" style="max-width: 100%;">
      </section>
      <footer class="modal-card-foot">
        <button type="button" class="button is-primary" id="confirmCrop"><%= t('psychologist_profile.modal.confirm_button') %></button>
        <button type="button" class="button" id="cancelCrop"><%= t('psychologist_profile.modal.cancel_button') %></button>
      </footer>
    </div>
  </div>

  <!-- Template for new education fields -->
  <% education_fields_template_content = capture do %>
    <%= form.fields_for :educations, Education.new, child_index: "NEW_RECORD" do |education_fields| %>
      <%= render "educations/form", f: education_fields %>
    <% end %>
  <% end %>
  <template id="education-fields-template">
    <%= education_fields_template_content %>
  </template>
<% end %>


<%# --- STYLES --- %>
<style>
  .box {
    box-shadow: 0 0.5em 1em -0.125em rgba(10, 10, 10, 0.1), 0 0px 0 1px rgba(10, 10, 10, 0.02);
    border-radius: 8px;
  }
  .border-bottom {
    border-bottom: 1px solid #dbdbdb;
  }
  .pb-4 {
    padding-bottom: 1rem;
  }
  .mb-5 {
    margin-bottom: 1.75rem;
  }
  
  /* Styling for the education remove button.
     This assumes the rendered partial for an education includes
     a button with the class 'remove-education-button' inside the '.box' container. */
  #educations-container .box {
    position: relative;
    padding-top: 2.5rem; /* Make space for the button at the top */
    box-shadow: none;
    background-color: #ebf1fdf3;
  }

  .remove-education-button {
    /* Positioning */
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    
    /* Reset button styles */
    border: none;
    background-color: transparent;
    padding: 0;
    margin: 0;
    font-family: inherit;
    
    /* Size and appearance */
    width: 28px;
    height: 28px;
    cursor: pointer;
    
    /* Hide original button text if any */
    font-size: 0;
    color: transparent;
    transition: background-color 0.2s ease-in-out;
    border-radius: 50%;
  }

  /* Create the 'X' icon using a pseudo-element */
  .remove-education-button::before {
    content: '×';
    font-size: 26px;
    line-height: 28px;
    color: #999; /* A neutral grey */
    display: block;
    text-align: center;
    transition: color 0.2s ease-in-out;
  }
  
  .remove-education-button:hover {
    background-color: #f0f0f0;
  }

  .remove-education-button:hover::before {
    color: #333; /* Darker on hover */
  }
</style>

<%# --- SCRIPTS (UNCHANGED) --- %>
<script>
document.addEventListener("turbo:load", function () {
  let cropper;

  const imageInput = document.getElementById("imageInput");
  if (!imageInput) return; 

  const imagePreview = document.getElementById("imagePreview");
  const cropModal = document.getElementById("cropModal");
  const confirmCrop = document.getElementById("confirmCrop");
  const cancelCrop = document.getElementById("cancelCrop");
  const closeModal = document.getElementById("closeModal");
  const croppedImageInput = document.getElementById("croppedImageInput");

  imageInput.addEventListener("change", function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (e) {
      imagePreview.src = e.target.result;
      cropModal.classList.add("is-active");

      imagePreview.onload = function () {
        if (cropper) cropper.destroy();
        cropper = new Cropper(imagePreview, {
          aspectRatio: 1,
          viewMode: 1,
        });
      };
    };
    reader.readAsDataURL(file);
  });

  [cancelCrop, closeModal].forEach((btn) => {
    btn.addEventListener("click", () => {
      cropModal.classList.remove("is-active");
      if (cropper) cropper.destroy();
    });
  });

  confirmCrop.addEventListener("click", () => {
    cropper.getCroppedCanvas().toBlob((blob) => {
      const file = new File([blob], "cropped_profile.jpg", { type: "image/jpeg" });

      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      croppedImageInput.files = dataTransfer.files;

      cropModal.classList.remove("is-active");
      cropper.destroy();
    });
  });
});

document.addEventListener('turbo:load', function() {
    // Dynamic Education Fields Logic
    const addEducationButton = document.getElementById('add-education-button');
    const educationsContainer = document.getElementById('educations-container');
    const educationTemplate = document.getElementById('education-fields-template');

    if (addEducationButton && educationsContainer && educationTemplate) {
      document.addEventListener('click', function(event) {
        if (event.target.closest('.remove-education-button')) {
          event.preventDefault();
          const educationBox = event.target.closest('.box.mb-4');
          if (educationBox) {
            const destroyField = educationBox.querySelector('input[name*="_destroy"]');
            if (destroyField) {
              destroyField.value = '1'; // mark for deletion
              educationBox.style.display = 'none';
            } else {
              educationBox.remove(); // for new records
            }
          }
        }
      });

      addEducationButton.addEventListener('click', (event) => {
        event.preventDefault(); // Prevent form submission
        const content = educationTemplate.innerHTML.replace(/NEW_RECORD/g, new Date().getTime());
        const newDiv = document.createElement('div');
        newDiv.innerHTML = content;
        educationsContainer.appendChild(newDiv);
      });

      educationsContainer.addEventListener('click', (event) => {
        if (event.target.matches('input[type="checkbox"][name*="_destroy"]')) {
          const checkbox = event.target;
          const educationBox = checkbox.closest('.box.mb-4');
          if (educationBox) {
            educationBox.style.display = checkbox.checked ? 'none' : 'block';
          }
        }
      });
    }

    // Country and City Select Logic
    const countrySelect = document.getElementById('country-select');
    const citySelect = document.getElementById('city-select');
    const countryData = <%= raw countries_with_cities.to_json %>;

    if (countrySelect && citySelect) {
        const updateCities = () => {
            const selectedCountry = countrySelect.value;
            const savedCity = citySelect.getAttribute('data-saved-city') || '<%= j(@psychologist_profile.city) %>';

            citySelect.innerHTML = '';
            citySelect.disabled = !selectedCountry;

            const placeholder = new Option('<%= t('psychologist_profile.prompts.select_city') %>', '', true, true);
            placeholder.disabled = true;
            citySelect.add(placeholder);

            if (selectedCountry) {
                const country = countryData.find(c => c.name === selectedCountry);
                if (country && country.cities) {
                    country.cities.forEach(city => {
                        const option = new Option(city, city);
                        if (city === savedCity) {
                            option.selected = true;
                            placeholder.selected = false;
                        }
                        citySelect.add(option);
                    });
                }
            }
        };

        countrySelect.addEventListener('change', updateCities);
        if (countrySelect.value) {
            updateCities();
        }
    }


    // TomSelect Initialization
    const initTomSelect = (selector, config) => {
        document.querySelectorAll(selector).forEach((el) => {
            if (!el.tomselect) {
                new TomSelect(el, config);
            }
        });
    };

    const commonMultiConfig = {
      plugins: ['remove_button'],
      maxItems: null,
      persist: false,
      create: false,
      closeAfterSelect: false,
    };

    initTomSelect('.tom-select-issues, .tom-select-specialties, .tom-select-client-types, .tom-select-languages', commonMultiConfig);

    const timezoneSelectElement = document.getElementById('timezone_select');
    if (timezoneSelectElement && !timezoneSelectElement.tomselect) {
      const tomSelectInstance = new TomSelect(timezoneSelectElement, {
        maxItems: 1,
        persist: false,
        create: false,
        plugins: ['dropdown_input'],
        sortField: { field: "text", direction: "asc" },
        placeholder: timezoneSelectElement.getAttribute('data-placeholder') || "Select your time zone",
        allowEmptyOption: true,
      });

      if (typeof Intl?.DateTimeFormat === 'function') {
        try {
          const browserTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
          tomSelectInstance.setValue(browserTimeZone, true); // silent = true to prevent 'change' event
        } catch (error) {
          console.error("Error detecting browser time zone:", error);
        }
      }
    }
});

document.addEventListener("turbo:load", function () {
  const firstName = document.getElementById("psychologist_profile_first_name");
  const lastName = document.getElementById("psychologist_profile_last_name");
  const submitBtn = document.querySelector("input[type=submit]");

  function toggleSubmit() {
    if (firstName.value.trim() === "" || lastName.value.trim() === "") {
      submitBtn.disabled = true;
    } else {
      submitBtn.disabled = false;
    }
  }

  if (firstName && lastName && submitBtn) {
    toggleSubmit(); // initial check
    firstName.addEventListener("input", toggleSubmit);
    lastName.addEventListener("input", toggleSubmit);
  }
});

document.addEventListener("turbo:load", () => {
  const input = document.getElementById("profile_url_input");
  const errorEl = document.getElementById("profile_url_error");
  const previewEl = document.getElementById("profile_url_preview");

  const regex = /^[a-z0-9_-]{3,30}$/;
  let timeout;

  const updatePreview = (value) => {
    previewEl.textContent = value || "your-url-here";
  };

  // Initialize preview on page load
  updatePreview(input.value);

  input.addEventListener("input", () => {
    const value = input.value.trim();

    // Clear previous error
    errorEl.style.display = "none";
    errorEl.textContent = "";

    // Update preview (always)
    updatePreview(value);

    // Show format error if invalid
    if (value && !regex.test(value)) {
      errorEl.style.display = "block";
      errorEl.textContent = "URL can only contain 3–30 lowercase letters, numbers, hyphens, underscores";
      return;
    }

    if (value) {
      // Debounce AJAX uniqueness check
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        fetch(`/psychologist_profiles/check_profile_url?profile_url=${encodeURIComponent(value)}`)
          .then(res => res.json())
          .then(data => {
            if (data.taken) {
              errorEl.style.display = "block";
              errorEl.textContent = "This URL is already taken";
            }
          });
      }, 500);
    }
  });
});



</script>

