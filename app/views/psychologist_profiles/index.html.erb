<style>
  :root {
    --primary-main: #2C3E50; /* The core dark blue/grey */
    --primary-light: #34495e; /* Slightly lighter shade of primary for accents */
    --primary-dark: #1A2B3C; /* Darker shade for hover states */
    
    /* New color palette */
    --accent-blue: #1098F7;
    --accent-cyan: #16BAC5;
    --accent-green: #3F784C;
    --accent-rose: #C98686;
    --accent-pale-yellow: #F4F1BB;
    --accent-teal: #1B998B;
  }

  @media screen and (min-width: 769px) {
    [x-cloak] {
      display: block !important;
    }

    .filter-section {
      display: block !important;
    }
  }

  @media screen and (max-width: 768px) {
    .box {
      margin: 0.5rem;
      padding: 1rem;
    }

    .field.has-addons .control:not(:last-child) .button,
    .field.has-addons .control:not(:last-child) .input {
      border-radius: 4px 0 0 4px;
    }

    .field.has-addons .control:last-child .button,
    .field.has-addons .control:last-child .input {
      border-radius: 0 4px 4px 0;
    }

    .tags .tag {
      margin-bottom: 0.25rem;
    }

    .button.is-fullwidth {
      justify-content: space-between;
    }
  }

  .field:not(:last-child) {
    margin-bottom: 1rem;
  }

  .delivery-method .delivery-method-input {
    position: absolute;
    opacity: 0;
  }

  .delivery-method {
    background-color: white;
    border: 1px solid #dbdbdb;
    color: #363636;
    padding: 0.5rem 1rem;
    cursor: pointer;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
  }

  .delivery-method:has(.delivery-method-input:checked) {
    background-color: var(--primary-main);
    border-color: var(--primary-main);
    color: white;
  }

  .delivery-method .delivery-method-input:checked ~ .icon,
  .delivery-method .delivery-method-input:checked ~ span {
    color: white;
  }

  .delivery-method:hover {
    border-color: var(--primary-light); /* Slightly lighter on hover */
  }

  .delivery-method:focus-within {
    box-shadow: 0 0 0 0.125em rgba(44, 62, 80, 0.25); /* Using primary-main RGB for shadow */
  }

  .delivery-method-container .field {
    margin-bottom: 1rem;
  }

  .delivery-method-container .label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #363636;
  }

  .delivery-method-container .is-grouped {
    display: flex;
    gap: 0.5rem;
  }

  .delivery-method-container .control {
    display: flex;
    align-items: center;
  }

  /* Advanced Filters Styles */
  .advanced-filters-section {
    margin-top: 0;
  }

  /* NEW: Updated box style for advanced filters */
  .advanced-filters-section .box.is-accented {
    border: 1px solid #e8e8e8;
    border-left: 5px solid var(--accent-cyan);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    margin-top: 1.5rem;
    background-color: #fdfdfd;
  }

  .advanced-filters-section .label .icon-text {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  /* NEW: Color-coded icons for advanced filters */
  .field-client-type .label .icon { color: var(--accent-blue); }
  .field-specialty .label .icon { color: var(--accent-teal); }
  .field-issue .label .icon { color: var(--accent-rose); }
  .field-language .label .icon { color: var(--accent-green); }
  .field-gender .label .icon { color: var(--primary-dark); }

  .advanced-filters-section .field {
    margin-bottom: 1.25rem;
  }

  /* New style for the advanced filter text toggle */
  .advanced-filters-toggle-text {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: var(--primary-main); /* Changed to primary-main for a more distinct look */
    font-weight: 600;
    transition: color 0.2s ease;
  }

  .advanced-filters-toggle-text:hover {
    color: var(--primary-dark); /* Darker on hover */
  }

  .advanced-filters-toggle-text .icon {
    transition: transform 0.2s ease;
  }

  /* Container for centering the text toggle */
  .advanced-filters-wrapper {
    text-align: center;
    margin-top: 1.5rem; /* Add some space above */
    margin-bottom: 2rem; /* Add some space below */
  }

  /* Custom styling for the horizontal rule separator */
  .filter-separator {
    border: 0;
    height: 1px;
    background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0));
    margin: 2rem 0; /* Adjust vertical spacing as needed */
  }

  /* Custom class for primary blue button, using new variables */
  .button.is-primary-blue {
    background-color: var(--primary-light); /* Changed to lighter color */
    border-color: transparent;
    color: white;
  }

  .button.is-primary-blue:hover {
    background-color: var(--primary-main); /* Darker on hover */
    border-color: transparent;
  }

  .button.is-primary-blue:focus {
    box-shadow: 0 0 0 0.125em rgba(44, 62, 80, 0.25);
  }

  /* NEW: Custom tag style for specialties */
  .tag.is-specialty-tag {
    background-color: var(--accent-teal);
    color: white;
    font-weight: 500;
  }
</style>

<div class="box">
  <%= form_tag psychologist_profiles_path, method: :get, class: "search-form" do %>

    <div class="field has-addons mb-4">
      <div class="control is-expanded has-icons-left">
        <%= text_field_tag :search, params[:search],
            class: "input is-medium",
            placeholder: t('psychologist_search.placeholder') %>
        <span class="icon is-left">
          <i class="fas fa-search"></i>
        </span>
      </div>
      <div class="control">
        <button class="button  is-medium" type="submit">
          <span class="icon is-hidden-mobile">
            <i class="fas fa-search"></i>
          </span>
          <span class="is-hidden-tablet"><%= t('psychologist_search.search_button') %></span>
          <span class="is-hidden-mobile"><%= t('psychologist_search.search_button') %></span>
        </button>
      </div>
      <% if any_filters_active?(params) %>
        <div class="control">
          <%= link_to psychologist_profiles_path, class: "button is-primary-blue is-medium" do %>
            <span class="icon">
              <i class="fas fa-times"></i>
            </span>
            <span class="is-hidden-mobile"><%= t('psychologist_search.clear_all') %></span>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="block" x-data="{ showFilters: window.innerWidth > 768, showAdvanced: false }">
      <button type="button"
              class="button is-light is-fullwidth is-justify-content-space-between is-hidden-tablet"
              @click="showFilters = !showFilters"
              x-show="!showFilters">
        <span>
          <span class="icon">
            <i class="fas fa-filter"></i>
          </span>
          <span><%= t('psychologist_search.filters') %></span>
        </span>
        <span class="icon">
          <i class="fas fa-chevron-down"></i>
        </span>
      </button>

      <div x-show="showFilters" x-transition class="box mt-3">

        <div class="columns is-multiline">
          <div class="column is-6-tablet is-12-mobile">
            <div class="delivery-method-container">
              <div class="field">
                <label class="label"><%= t('psychologist_search.delivery_method_label') %></label>
                <div class="field is-grouped is-grouped-multiline">
                  <div class="control">
                    <label class="button delivery-method">
                      <%= check_box_tag "in_person", "1", params[:in_person] == "1", class: "delivery-method-input" %>
                      <span class="icon">
                        <i class="fas fa-user"></i>
                      </span>
                      <span><%= t('psychologist_search.in_person') %></span>
                    </label>
                  </div>
                  <div class="control">
                    <label class="button delivery-method">
                      <%= check_box_tag "online", "1", params[:online] == "1", class: "delivery-method-input" %>
                      <span class="icon">
                        <i class="fas fa-laptop"></i>
                      </span>
                      <span><%= t('psychologist_search.online') %></span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-6-tablet is-12-mobile">
            <div class="field">
              <label class="label"><%= t('psychologist_search.price_range_label') %></label>
              <div class="field has-addons">
                <div class="control is-expanded">
                  <%= number_field_tag :min_rate, params[:min_rate],
                      step: 1,
                      class: "input",
                      min: 0,
                      placeholder: t('psychologist_search.min_rate_placeholder') %>
                </div>

                <div class="control is-expanded">
                  <%= number_field_tag :max_rate, params[:max_rate],
                      step: 1,
                      class: "input",
                      min: 0,
                      placeholder: t('psychologist_search.max_rate_placeholder') %>
                </div>

                <div class="control">
                  <input class="input is-static has-text-weight-semibold" type="text" readonly value=" <%= current_currency %>">
                </div>
              </div>
            </div>
          </div>
        </div>

        <%= turbo_frame_tag "location_filters" do %>
          <div class="columns is-multiline">
            <div class="column is-6-tablet is-12-mobile">
              <div class="field">
                <label class="label"><%= t('psychologist_search.country_label') %></label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <%= select_tag :country,
                        options_for_select(
                          [[t('psychologist_search.all_countries'), '']] +
                          @countries_with_cities.map { |c| [t("countries.#{c['name']}"), c['name']] },
                          params[:country]
                        ),
                        class: "select filter-select",
                        id: "search-country",
                        onchange: "this.form.requestSubmit()" %>
                  </div>
                </div>
              </div>
            </div>

            <div class="column is-6-tablet is-12-mobile">
              <div class="field">
                <label class="label"><%= t('psychologist_search.city_label') %></label>
                <div class="control">
                  <div class="select is-fullwidth">
                    <%= select_tag :city,
                        options_for_select(
                          [[t('psychologist_search.all_cities'), '']] +
                          @cities_for_select.map { |city_name| [t("cities.#{city_name}"), city_name] },
                          params[:city]
                        ),
                        class: "select filter-select",
                        id: "search-city",
                        disabled: @cities_for_select.empty? %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <div x-show="showAdvanced"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="opacity-0 transform scale-95"
             x-transition:enter-end="opacity-100 transform scale-100"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="opacity-100 transform scale-100"
             x-transition:leave-end="opacity-0 transform scale-95"
             class="advanced-filters-section">

          <div class="box is-accented">
            <div class="columns is-multiline">
              <div class="column is-6-tablet is-12-mobile">
                <div class="field field-client-type">
                  <label class="label">
                    <span class="icon-text">
                      <span class="icon">
                        <i class="fas fa-users"></i>
                      </span>
                      <span><%= t('psychologist_search.client_types_label') %></span>
                    </span>
                  </label>
                  <div class="control">
                    <div class="select is-fullwidth">
                      <%= select_tag :client_type_id,
                          options_for_select(
                            [[t('psychologist_search.all_client_types'), '']] +
                            ClientType.all.map { |i| [t("client_types.#{i.name}"), i.id] },
                            params[:client_type_id]
                          ),
                          class: "select filter-select"
                          %>
                    </div>
                  </div>
                </div>
              </div>

              <div class="column is-6-tablet is-12-mobile">
                <div class="field field-specialty">
                  <label class="label">
                    <span class="icon-text">
                      <span class="icon">
                        <i class="fas fa-brain"></i>
                      </span>
                      <span><%= t('psychologist_search.specialties_label') %></span>
                    </span>
                  </label>
                  <div class="control">
                    <%= select_tag :specialty_ids,
                        options_for_select(
                          Specialty.all.map { |s| [s.name, s.id] },
                          params[:specialty_ids]
                        ),
                        multiple: true,
                        class: "filter-select tom-select",
                        id: "specialties-select" %>
                  </div>
                </div>
              </div>

              <div class="column is-6-tablet is-12-mobile">
                <div class="field field-issue">
                  <label class="label">
                    <span class="icon-text">
                      <span class="icon">
                        <i class="fas fa-heart"></i>
                      </span>
                      <span><%= t('psychologist_search.issues_label') %></span>
                    </span>
                  </label>
                  <div class="control">
                    <%= select_tag :issue_ids,
                        options_for_select(
                          Issue.all.map { |i| [i.name, i.id] },
                          params[:issue_ids]
                        ),
                        multiple: true,
                        class: "filter-select tom-select",
                        id: "issues-select" %>
                  </div>
                </div>
              </div>

              <div class="column is-6-tablet is-12-mobile">
                <div class="field field-language">
                  <label class="label">
                    <span class="icon-text">
                      <span class="icon">
                        <i class="fas fa-language"></i>
                      </span>
                      <span><%= t('psychologist_search.languages_label') %></span>
                    </span>
                  </label>
                  <div class="control">
                    <%= select_tag "language_ids",
                        options_for_select(
                          Language.all.map { |lang| [t("spoken_languages.#{lang.name}"), lang.id] },
                          selected: params[:language_ids]
                        ),
                        multiple: true,
                        class: "tom-select filter-select",
                        id: "languages-select",
                        data: { placeholder: t('psychologist_search.select_languages_placeholder') } %>
                  </div>
                </div>
              </div>

              <div class="column is-6-tablet is-12-mobile">
                <div class="field field-gender">
                  <label class="label">
                    <span class="icon-text">
                      <span class="icon">
                        <i class="fas fa-user-friends"></i>
                      </span>
                      <span><%= t('psychologist_search.gender_label') %></span>
                    </span>
                  </label>
                  <div class="control">
                    <div class="select is-fullwidth">
                      <%= select_tag :gender,
                          options_for_select(
                            [[t('psychologist_search.any_gender'), '']] +
                            @genders.map { |g| [t("enums.gender.#{g}"), g] },
                            params[:gender]
                          ),
                          class: "select" %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="advanced-filters-wrapper">
          <span class="advanced-filters-toggle-text"
                role="button"
                @click="showAdvanced = !showAdvanced">
            <span class="icon">
              <i class="fas fa-sliders-h"></i>
            </span>
            <span x-text="showAdvanced ? 'Hide Advanced Filters' : 'More Filter Options'"></span>
            <span class="icon is-small">
              <i class="fas" :class="showAdvanced ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            </span>
          </span>
        </div>

        <hr class="filter-separator">

        <div class="field mt-4">
          <div class="control">
            <button type="submit" class="button  is-fullwidth">
              <span class="icon">
                <i class="fas fa-check"></i>
              </span>
              <span><%= t('psychologist_search.apply_filters_button') %></span>
            </button>
          </div>
        </div>

      </div>
    </div>
  <% end %>
</div>


<div class="profiles-container">
  <% @psychologist_profiles.each do |profile| %>
    <div class="profile-card box mb-4">
      <div class="columns is-vcentered">
        <div class="column is-narrow has-text-centered">
          <figure class="image is-96x96 mx-auto">
            <% if profile.profile_img.attached? %>
              <%= image_tag profile.profile_img.variant(resize_to_limit: [96, 96]), class: "is-rounded"%>
            <% else %>
                 <%= image_tag "default-profile.png", alt: "Default Profile", class: "is-rounded profile-image" %>
            <% end %>
          </figure>
        </div>
        
        <div class="column profile-info">
          <div class="columns">
            <div class="column">
              <h3 class="title is-5 mb-1">
                <% if profile.is_doctor %><%= t('psychologist_search.phd_badge') %> <% end %><%= profile.first_name %> <%= profile.last_name %> 
              </h3>
              
              <div class="mb-2">
                <% if profile.standard_rate.present? %>
                  <span class="tag is-light">
                    <i class="fas fa-money-bill-wave mr-1">
                    </i> <% converted = profile.converted_rate(current_currency) %>
<%= humanized_money_with_symbol(converted) %>

                  </span>
                <% end %>
                <% if profile.is_doctor %>
                  <span class="tag is-primary is-light ml-1">
                    <i class="fas fa-user-md mr-1"></i> <%= t('psychologist_search.phd_badge') %>
                  </span>
                <% end %>
                <% if profile.is_degree_boolean %>
                  <span class="tag is-info is-light ml-1">
                    <i class="fas fa-certificate mr-1"></i> <%= t('psychologist_search.certified_badge') %>
                  </span>
                <% end %>
              </div>
              
              <% if profile.city.present? || profile.country.present? || profile.years_of_experience.present? %>
                <p class="location-text mb-2">
                  <% if profile.city.present? || profile.country.present? %>
                    <span class="icon is-small"><i class="fas fa-map-marker-alt"></i></span>
                    <%= [profile.city, profile.country].compact.join(", ") %>
                  <% end %>
                  <% if profile.years_of_experience.present? %>
                    <span class="ml-2"><i class="fas fa-clock"></i> <%= t('psychologist_profiles.show.years_experience_short', count: profile.years_of_experience) %></span>
                  <% end %>
                </p>
              <% end %>
              
              <% if profile.about_me.present? %>
                <p class="has-text-grey is-size-7 mb-2">
                  <%= truncate(profile.about_me, length: 600) %>
                </p>
              <% end %>
              
              <% if profile.specialties.any? || profile.issues.any? %>
                <div class="tags are-small mt-2">
                  <% profile.specialties.each do |specialty| %>
                    <span class="tag is-specialty-tag"><%= specialty.name %></span>
                  <% end %>
              
                </div>
              <% end %>
              
              <% if profile.client_types.any? %>
                <p class="is-size-7 has-text-grey mt-2">
                  <span class="icon is-small"><i class="fas fa-users"></i></span>
                  <%= profile.client_types.map(&:name).join(" • ") %>
                </p>
              <% end %>
            </div>

            <div class="column is-narrow">
              <div class="buttons are-small is-flex is-flex-direction-column">
                <%= link_to psychologist_profile_path(profile), class: "button is-primary-blue mb-2" do %>
                  <span class="icon is-small"><i class="fas fa-user"></i></span>
                  <span><%= t('psychologist_search.view_profile_button') %></span>
                <% end %>
                
                <button class="button is-text contact-button" data-target="contact-<%= profile.id %>">
                  <span class="icon is-small"><i class="fas fa-envelope"></i></span>
                  <span><%= t('psychologist_search.contact_button') %></span>
                </button>
              </div>
              
              <div class="contact-icons mt-2">
                <% if profile.contact_phone.present? %>
                  <a href="tel:<%= profile.contact_phone %>" class="is-primary-blue mr-1" title="Phone">
                    <span class="icon"><i class="fas fa-phone"></i></span>
                  </a>
                <% end %>
                
                <% if profile.user.email.present? %>
                  <a href="mailto:<%= profile.user.email %>" class="is-primary-blue mr-1" title="Email">
                    <span class="icon"><i class="fas fa-envelope"></i></span>
                  </a>
                <% end %>
                
                <% if profile.telegram.present? %>
                  <a href="https://t.me/<%= profile.telegram %>" target="_blank" class="is-primary-blue mr-1" title="Telegram">
                    <span class="icon"><i class="fab fa-telegram"></i></span>
                  </a>
                <% end %>
                
                <% if profile.whatsapp.present? %>
                  <a href="https://wa.me/<%= profile.whatsapp %>" target="_blank" class="is-primary-blue" title="WhatsApp">
                    <span class="icon"><i class="fab fa-whatsapp"></i></span>
                  </a>
                <% end %>
              </div>
              
              <div id="contact-<%= profile.id %>" class="contact-info mt-2" style="display: none;">
                <% if profile.contact_phone.present? %>
                  <p class="is-size-7">
                    <span class="icon is-small"><i class="fas fa-phone"></i></span>
                    <a href="tel:<%= profile.contact_phone %>"><%= profile.contact_phone %></a>
                  </p>
                <% end %>
                
                <% if profile.user.email.present? %>
                  <p class="is-size-7">
                    <span class="icon is-small"><i class="fas fa-envelope"></i></span>
                    <a href="mailto:<%= profile.user.email %>"><%= profile.user.email %></a>
                  </p>
                <% end %>
                
                <% if profile.telegram.present? %>
                  <p class="is-size-7">
                    <span class="icon is-small"><i class="fab fa-telegram"></i></span>
                    <a href="https://t.me/<%= profile.telegram %>" target="_blank">@<%= profile.telegram %></a>
                  </p>
                <% end %>
                
                <% if profile.whatsapp.present? %>
                  <p class="is-size-7">
                    <span class="icon is-small"><i class="fab fa-whatsapp"></i></span>
                    <a href="https://wa.me/<%= profile.whatsapp %>" target="_blank"><%= profile.whatsapp %></a>
                  </p>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>








<script>
  document.addEventListener('turbo:load', function () {
    // Toggle contact info
    document.querySelectorAll('.contact-button').forEach(function (button) {
      button.addEventListener('click', function (e) {
        e.preventDefault();
        const targetId = this.getAttribute('data-target');
        const contactInfo = document.getElementById(targetId);
        if (contactInfo) {
          contactInfo.style.display = contactInfo.style.display === 'none' ? 'block' : 'none';
        }
      });
    });

    // Clear filters
    document.getElementById('clear-all-filters')?.addEventListener('click', function (e) {
      e.preventDefault();
      const form = document.querySelector('.search-form');
      const url = new URL(form.action);
      form.reset();
      window.location.href = url.pathname;
    });

    document.querySelectorAll(".tom-select").forEach((el) => {
      // Skip initialization for country and city selects
      if (el.id === 'search-country' || el.id === 'search-city') return;
      
      // Only initialize if not already initialized
      if (!el.classList.contains('tomselected')) {
        new TomSelect(el, {
          plugins: ['remove_button'],
          persist: false,
          create: false,
          placeholder: el.getAttribute('data-placeholder') || 'Выберите...'
        });
      }
    });

    // TomSelect for issues (with duplicate initialization check)
    const issuesSelect = document.getElementById("issues-select");
    if (issuesSelect && !issuesSelect.classList.contains('tomselected')) {
      new TomSelect(issuesSelect, {
        plugins: ['remove_button'],
        persist: false,
        create: false,
        placeholder: 'Выберите проблемы'

      });
    }

    // TomSelect for specialties (with duplicate initialization check)
    const specialtiesSelect = document.getElementById("specialties-select");
    if (specialtiesSelect && !specialtiesSelect.classList.contains('tomselected')) {
      new TomSelect(specialtiesSelect, {
        plugins: ['remove_button'],
        persist: false,
        create: false,
        placeholder: 'Выберите специальности'
      });
    }

    

  });
</script>