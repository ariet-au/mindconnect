<!-- Simplified Search and Filter Bar -->
<div class="search-card">
  <%= form_tag psychologist_profiles_path, method: :get, class: "search-form" do %>
    <div class="search-header">
      <div class="field has-addons">
        <div class="control is-expanded">
          <%= text_field_tag :search, params[:search], 
                class: "input", 
                placeholder: "Name, specialty, or keyword..." %>
        </div>
        <div class="control">
          <button class="button is-primary" type="submit">
            <span class="icon"><i class="fas fa-search"></i></span>
          </button>
        </div>
        <% if any_filters_active?(params) %>
          <div class="control">
            <%= link_to psychologist_profiles_path, class: "button is-light" do %>
              <span class="icon"><i class="fas fa-times"></i></span>
              <span>Clear All</span>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <div class="search-body p-2">
  <!-- Active Filters Display -->
  <% if any_filters_active?(params) %>
    <div class="field is-grouped is-grouped-multiline mb-2">
      <% if params[:search].present? %>
        <div class="control">
          <div class="tags has-addons">
            <span class="tag is-primary">Search: <%= params[:search] %></span>
            <%= link_to psychologist_profiles_path(request.query_parameters.except(:search)), class: "tag is-delete" do %>
              <i class="fas fa-times"></i>
            <% end %>
          </div>
        </div>
      <% end %>

      <% (params[:specialty_ids] || []).each do |id| %>
        <% specialty = Specialty.find_by(id: id) %>
        <% if specialty %>
          <div class="control">
            <div class="tags has-addons">
              <span class="tag is-info"><%= specialty.name %></span>
              <%= link_to psychologist_profiles_path(request.query_parameters.except(:specialty_ids).merge(specialty_ids: request.query_parameters[:specialty_ids] - [id.to_s])), class: "tag is-delete" do %>
                <i class="fas fa-times"></i>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>

      <% (params[:issue_ids] || []).each do |id| %>
        <% issue = Issue.find_by(id: id) %>
        <% if issue %>
          <div class="control">
            <div class="tags has-addons">
              <span class="tag is-warning"><%= issue.name %></span>
              <%= link_to psychologist_profiles_path(request.query_parameters.except(:issue_ids).merge(issue_ids: request.query_parameters[:issue_ids] - [id.to_s])), class: "tag is-delete" do %>
                <i class="fas fa-times"></i>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>

      <% (params[:client_type_ids] || []).each do |id| %>
        <% client_type = ClientType.find_by(id: id) %>
        <% if client_type %>
          <div class="control">
            <div class="tags has-addons">
              <span class="tag is-success"><%= client_type.name %></span>
              <%= link_to psychologist_profiles_path(request.query_parameters.except(:client_type_ids).merge(client_type_ids: request.query_parameters[:client_type_ids] - [id.to_s])), class: "tag is-delete" do %>
                <i class="fas fa-times"></i>
              <% end %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <!-- Filter Dropdowns - Simplified Version -->
  <div class="field is-grouped is-grouped-multiline">
    <!-- Specialty Filter -->
    <div class="control">
      <%= select_tag :specialty_ids, 
          options_for_select(
            Specialty.all.map { |s| [s.name, s.id] },
            params[:specialty_ids]
          ),
          multiple: true,
          class: "select is-small is-multiple",
          onchange: "this.form.submit()" %>
    </div>

    <!-- Issue Filter -->
    <div class="control">
      <%= select_tag :issue_ids, 
          options_for_select(
            Issue.all.map { |i| [i.name, i.id] },
            params[:issue_ids]
          ),
          multiple: true,
          class: "select is-small is-multiple",
          onchange: "this.form.submit()" %>
    </div>

    <!-- Client Type Filter -->
    <div class="control">
      <%= select_tag :client_type_ids, 
          options_for_select(
            ClientType.all.map { |i| [i.name, i.id] },
            params[:client_type_ids]
          ),
          multiple: true,
          class: "select is-small is-multiple",
          onchange: "this.form.submit()" %>
    </div>



    
  </div>
</div>


        <!-- Location Filter -->
        <div class="control">
          <%= select_tag :country, 
              options_for_select(
                [['All Countries', '']] + 
                PsychologistProfile.distinct.pluck(:country).compact.sort,
                params[:country]
              ),
              class: "select is-small",
              onchange: "this.form.submit()" %>
        </div>

                <!-- Location Filter -->
        <div class="control">
          <%= select_tag :gender, 
              options_for_select(
                [['Any Gender', '']] + 
                PsychologistProfile.distinct.pluck(:gender).compact.sort,
                params[:gender]
              ),
              class: "select is-small",
              onchange: "this.form.submit()" %>
        </div>
      </div>
    </div>
  <% end %>
</div>
























<!-- Psychologist Profiles -->
<div class="profiles-container">
  <% @psychologist_profiles.each do |profile| %>
    <div class="profile-card">
      <div class="columns is-mobile">
        <!-- Profile Image -->
        <div class="column is-2-desktop is-3-tablet is-4-mobile profile-img-container has-text-centered">
          <figure class="image is-96x96 mx-auto">
            <% if profile.profile_img.attached? %>
              <%= image_tag url_for(profile.profile_img), class: "is-rounded profile-image" %>
            <% else %>
              <img src="/api/placeholder/96/96" alt="Profile Image" class="is-rounded profile-image">
            <% end %>
          </figure>
        </div>
        
        <!-- Profile Info -->
        <div class="column profile-info">
          <div class="columns is-mobile">
            <div class="column">
              <!-- Name and Badges -->
              <h3 class="title is-5 mb-1">
                <% if profile.is_doctor %>Dr. <% end %><%= profile.first_name %> <%= profile.last_name %>
              </h3>
              <p class="mb-2">
                <% if profile.is_doctor %>
                  <span class="qualification-badge">
                    <i class="fas fa-user-md"></i> PhD
                  </span>
                <% end %>
                <% if profile.is_degree_boolean %>
                  <span class="qualification-badge">
                    <i class="fas fa-certificate"></i> Certified
                  </span>
                <% end %>
              </p>
              
              <!-- Location -->
              <p class="location-text mb-2">
                <span class="icon is-small"><i class="fas fa-map-marker-alt"></i></span>
                <%= profile.city %>, <%= profile.country %>
                <span class="ml-2"><i class="fas fa-clock"></i> <%= profile.years_of_experience %> years exp.</span>
              </p>
              
              <!-- Short Bio -->
              <p class="has-text-grey is-size-7 mb-2">
                <%= truncate(profile.about_me, length: 150) %>
              </p>
              
              <!-- Specialties Tags -->
              <div class="tags are-small mt-2">
                <% profile.specialties.each do |specialty| %>
                  <span class="tag is-specialty"><%= specialty.name %></span>
                <% end %>
                <% profile.issues.each do |issue| %>
                  <span class="tag is-issue"><%= issue.name %></span>
                <% end %>
              </div>
              
              <!-- Client Types (shown at bottom) -->
              <p class="is-size-7 has-text-grey mt-2">
                <span class="icon is-small"><i class="fas fa-users"></i></span>
                <% profile.client_types.each_with_index do |client_type, index| %>
                  <% if index > 0 %> â€¢ <% end %>
                  <span><%= client_type.name %></span>
                <% end %>
              </p>
            </div>
            
            <!-- Contact Information (right side) -->
            <div class="column is-narrow">
              <div class="buttons are-small is-flex is-flex-direction-column">
                <%= link_to psychologist_profile_path(profile), class: "button is-primary is-outlined mb-2" do %>
                  <span class="icon is-small"><i class="fas fa-user"></i></span>
                  <span>View Profile</span>
                <% end %>
                <button class="button is-text contact-button" data-target="contact-<%= profile.id %>">
                  <span class="icon is-small"><i class="fas fa-envelope"></i></span>
                  <span>Contact</span>
                </button>
              </div>
              <!-- Hidden Contact Info -->
              <div id="contact-<%= profile.id %>" class="contact-info mt-2">
                <% if profile.contact_phone.present? %>
                  <p class="is-size-7">
                    <span class="icon is-small"><i class="fas fa-phone"></i></span>
                    <a href="tel:<%= profile.contact_phone %>"><%= profile.contact_phone %></a>
                  </p>
                <% end %>
                <p class="is-size-7">
                  <span class="icon is-small"><i class="fas fa-envelope"></i></span>
                  <a href="mailto:<%= profile.user.email %>"><%= profile.user.email %></a>
                </p>
                <% if profile.telegram.present? %>
                  <p class="is-size-7">
                    <span class="icon is-small"><i class="fab fa-telegram"></i></span>
                    <a href="https://t.me/<%= profile.telegram %>" target="_blank">@<%= profile.telegram %></a>
                  </p>
                <% end %>
                <% if profile.whatsapp.present? %>
                  <p class="is-size-7">
                    <span class="icon is-small"><i class="fab fa-whatsapp"></i></span>
                    <a href="https://wa.me/<%= profile.whatsapp %>" target="_blank"><%= profile.whatsapp %></a>
                  </p>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>